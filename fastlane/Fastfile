# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  before_all do
    setup_circle_ci if ENV['CI']
  end

  desc "Release STAGING build to TestFlight (Internal Only)"
  lane :release_staging do
    ensure_git_status_clean
    ensure_git_branch(branch: 'develop')

    match(
      type: "appstore",
      app_identifier: "fm.playola.playolaradio.staging",
      readonly: true
    )

    build_app(
      project: "PlayolaRadio.xcodeproj",
      scheme: "PlayolaRadio-Staging",
      export_method: "app-store",
      output_directory: "./build",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "fm.playola.playolaradio.staging" => "match AppStore fm.playola.playolaradio.staging"
        }
      }
    )

    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: File.read(ENV["APP_STORE_CONNECT_API_KEY_PATH"])
    )

    upload_to_testflight(
      api_key: api_key,
      app_identifier: "fm.playola.playolaradio.staging",
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false
    )

    puts "âœ… Staging build uploaded to TestFlight!"
    puts "ðŸ“± App: fm.playola.playolaradio.staging"
  end

  desc "Release PRODUCTION build to TestFlight"
  lane :release_production do
    ensure_git_status_clean
    ensure_git_branch(branch: 'main')

    # Run tests before releasing to production
    scan(
      include_simulator_logs: false,
      parallel_testing: false,
      scheme: "PlayolaRadio",
      xcargs: "-skipMacroValidation -skipPackagePluginValidation",
      xcodebuild_formatter: "xcbeautify"
    )

    # Increment build number
    increment_build_number(xcodeproj: "PlayolaRadio.xcodeproj")

    build_app(
      project: "PlayolaRadio.xcodeproj",
      scheme: "PlayolaRadio",
      export_method: "app-store"
    )

    upload_to_testflight(
      app_identifier: "fm.playola.playolaradio",
      skip_waiting_for_build_processing: true
    )

    # Commit build number bump
    commit_version_bump(
      message: "Bump build number",
      xcodeproj: "PlayolaRadio.xcodeproj"
    )

    push_to_git_remote

    puts "âœ… Production build uploaded to TestFlight!"
    puts "ðŸ“± App: fm.playola.playolaradio"
  end

  desc "Push a new beta build to TestFlight (Legacy - use release_production instead)"
  lane :beta do
    build_app(project: "PlayolaRadio.xcodeproj", scheme: "PlayolaRadio")
    upload_to_testflight
  end

  desc "Runs all the tests"
  lane :test do
    scan(
      include_simulator_logs: false,
      parallel_testing: false,
      scheme: "PlayolaRadio",
      xcargs: "-skipMacroValidation -skipPackagePluginValidation",
      xcodebuild_formatter: "xcbeautify",
      output_directory: './fastlane/test_output/xctest')
  end

  lane :lint_code do
    swiftlint(
        mode: :lint,
        strict: true, # Fails on warnings
        config_file: ".swiftlint.yml",
        executable: "swiftlint"
    )
  end

  desc "Run swift-format lint check"
  lane :format_check do
    sh("cd .. && make format-check")
  end

  desc "Ad-hoc build"
  lane :adhoc do
    match(type: "adhoc")
    gym(export_method: "ad-hoc")
  end
end
